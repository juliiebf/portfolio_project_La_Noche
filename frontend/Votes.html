<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votes - La Noche Karaoké Paris 9ème</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="background"></div>
  <header>
    <div class="top-header">
      <a href="index.html">
        <img src="images/Design sans titre.png" alt="La Noche Karaoke - Bannière" class="logo-main" />
      </a>
      <nav class="main-nav">
        <ul class="nav-links">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="reservation.html">Réservation</a></li>
          <li><a href="boissons.html">Boissons</a></li>
          <li><a href="chansons.html">Chansons</a></li>
          <li><a href="galerie.html">Galerie</a></li>
          <li><a href="votes.html" class="active">Votes</a></li> 
          <li><a href="contact.html">Contact</a></li>
        </ul>
        <a href="#" id="openModal" class="login-btn">Se connecter</a>
      </nav>
    </div>
  </header>
  
  <main> 
    <section class="hero-section">
      <div class="hero-content">
        <h1>Votes</h1>
        <p>Votez pour vos interprétations préférées !</p>
        
        <h2>Uploader une vidéo</h2>
        <form id="uploadForm">
          <input type="file" id="videoFile" accept="video/*" required />
          <button type="submit">Uploader</button>
        </form>
        
        <h2>Vidéos</h2>
        <table id="videoTable" border="1" style="width:100%; border-collapse: collapse; text-align: center;">
          <thead>
            <tr>
              <th>#</th>
              <th>Vidéo</th>
              <th>Nom utilisateur</th>
              <th>Likes</th>
              <th>Likez</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="videoList">
            <!-- Les vidéos uploadées apparaîtront ici -->
          </tbody>
        </table>

        <!-- Script JS d'upload et de likes -->
        <script>
          const API_URL = 'http://localhost:3000';
          let token = localStorage.getItem('token');
          const uploadForm = document.getElementById('uploadForm');
          const videoFileInput = document.getElementById('videoFile');
          const videoList = document.getElementById('videoList');

          // Charger les vidéos au démarrage
          loadVideos();

          // Upload d'une vidéo
          uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!token) {
              alert("Vous devez être connecté pour uploader une vidéo !");
              return;
            }

            const file = videoFileInput.files[0];
            if (!file) return alert("Veuillez sélectionner un fichier vidéo.");

            const formData = new FormData();
            formData.append('video', file);

            try {
              const response = await fetch(`${API_URL}/api/ranking/upload`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                body: formData
              });

              const data = await response.json();
              
              if (response.ok) {
                alert('Vidéo uploadée avec succès !');
                uploadForm.reset();
                loadVideos();
              } else {
                alert('Erreur : ' + data.error);
              }
            } catch (err) {
              console.error(err);
              alert('Erreur lors de l\'upload');
            }
          });

          // Charger toutes les vidéos depuis le backend
          async function loadVideos() {
            try {
              const response = await fetch(`${API_URL}/api/ranking`);
              const videos = await response.json();
              
              if (response.ok) {
                renderVideos(videos);
              } else {
                console.error('Erreur chargement vidéos:', videos);
              }
            } catch (err) {
              console.error('Erreur:', err);
            }
          }

          // Afficher les vidéos dans le tableau
          function renderVideos(videos) {
            videoList.innerHTML = '';
            
            // Récupère l'ID de l'utilisateur actuel depuis le token
            let currentUserId = null;
            if (token) {
              try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserId = payload.id;
              } catch (e) {
                console.error('Erreur décodage token:', e);
              }
            }
            
            videos.forEach((video, index) => {
              const tr = document.createElement('tr');
              
              // Numéro
              const tdIndex = document.createElement('td');
              tdIndex.textContent = index + 1;
              tr.appendChild(tdIndex);
              
              // Vidéo
              const tdVideo = document.createElement('td');
              const videoTag = document.createElement('video');
              videoTag.src = `${API_URL}/uploads/${video.filename}`;
              videoTag.width = 200;
              videoTag.controls = true;
              tdVideo.appendChild(videoTag);
              tr.appendChild(tdVideo);
              
              // Nom utilisateur
              const tdName = document.createElement('td');
              tdName.textContent = video.username || `${video.prenom} ${video.nom}`;
              tr.appendChild(tdName);
              
              // Likes
              const tdLikes = document.createElement('td');
              tdLikes.textContent = video.likes;
              tr.appendChild(tdLikes);
              
              // Bouton liker
              const tdLikeBtn = document.createElement('td');
              const likeBtn = document.createElement('button');
              likeBtn.textContent = 'Liker';
              likeBtn.onclick = () => likeVideo(video.id);
              tdLikeBtn.appendChild(likeBtn);
              tr.appendChild(tdLikeBtn);

              // Bouton supprimer (seulement si c'est la vidéo de l'utilisateur)
              const tdAction = document.createElement('td');
              if (currentUserId && video.user_id === currentUserId) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Supprimer';
                deleteBtn.style.backgroundColor = '#ff4444';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.style.borderRadius = '5px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.onclick = () => deleteVideo(video.id);
                tdAction.appendChild(deleteBtn);
              } else {
                tdAction.textContent = '-';
              }
              tr.appendChild(tdAction);

              videoList.appendChild(tr);
            });
          }

          // Supprimer une vidéo
          async function deleteVideo(videoId) {
            if (!token) {
              alert("Vous devez être connecté pour supprimer une vidéo !");
              return;
            }

            if (!confirm('Êtes-vous sûr de vouloir supprimer cette vidéo ?')) {
              return;
            }

            try {
              const response = await fetch(`${API_URL}/api/ranking/${videoId}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });

              const data = await response.json();
              
              if (response.ok) {
                alert('Vidéo supprimée avec succès !');
                loadVideos();
              } else {
                alert('Erreur : ' + data.error);
              }
            } catch (err) {
              console.error(err);
              alert('Erreur lors de la suppression');
            }
          }

          // Liker une vidéo
          async function likeVideo(videoId) {
            if (!token) {
              alert("Vous devez être connecté pour liker !");
              return;
            }

            try {
              const response = await fetch(`${API_URL}/api/ranking/${videoId}/like`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });

              const data = await response.json();
              
              if (response.ok) {
                alert('Like enregistré !');
                loadVideos();
              } else {
                alert('Erreur : ' + data.error);
              }
            } catch (err) {
              console.error(err);
              alert('Erreur lors du like');
            }
          }
        </script>
      </div>
    </section>
  </main>
  
  <footer style="background-color: #10060611; color: #777777; padding: 1rem 2rem; text-align: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <p style="margin: 0 0 0.5rem 0;">© 2025 La Noche Karaoké Paris. Tous droits réservés</p>
    <p style="margin: 0 0 1rem 0;">42 Rue des Martyrs, 75009 Paris | 01 42 82 42 82</p>
    <a href="contact.html" style="color: #22aaff; text-decoration: none; font-weight: 600; font-size: 0.9rem; border: 1px solid transparent; padding: 6px 14px; border-radius: 15px; background: rgba(34, 170, 255, 0.1); transition: background 0.3s, border-color 0.3s;">Contactez-nous</a>
  </footer>

  <!-- Pop-up connexion -->
  <div class="modal-bg" id="popupLogin">
    <div class="modal-popup">
      <div class="modal-tabs">
        <button class="tab-btn active" id="tabSignIn" type="button">Déjà inscrit</button>
        <button class="tab-btn" id="tabSignUp" type="button">Nouveau compte</button>
      </div>
      <div id="signInForm">
        <h2 class="modal-title">Connexion</h2>
      <form> 
        <label for="email">Email</label>
        <input type="email" id="email" name="email" autocomplete="email" required />
        <label for="password">Mot de passe</label>
        <input type="password" id="password" name="password" autocomplete="current-password" required />
        <button type="submit" class="modal-btn-main">SE CONNECTER</button>
      </form>

      </div>
      <div id="signUpForm" style="display:none;">
        <h2 class="modal-title">Nouveau compte</h2>
        <form>
          <label for="firstname">Prénom</label>
          <input type="text" id="firstname" name="firstname" autocomplete="given-name" required />

          <label for="lastname">Nom</label>
          <input type="text" id="lastname" name="lastname" autocomplete="family-name" required />

          <label for="newemail">Email</label>
          <input type="email" id="newemail" name="newemail" autocomplete="email" required />

          <label for="newpassword">Mot de passe</label>
          <input type="password" id="newpassword" name="newpassword" autocomplete="new-password" required />

          <button type="submit" class="modal-btn-main">CRÉER LE COMPTE</button>

        </form>
      </div>
    </div>
  </div>

  <script>
 
    // Gestion ouverture/fermeture du pop-up login
    const openModalBtn = document.getElementById("openModal");
    const popupLogin = document.getElementById("popupLogin");
    openModalBtn.onclick = function(e) {
      e.preventDefault();
      popupLogin.style.display = "flex";
    };
    popupLogin.onclick = function(e) {
      if (e.target === this) this.style.display = "none";
    };
    
    // Gestion des onglets connexion / inscription
    const tabSignIn = document.getElementById("tabSignIn");
    const tabSignUp = document.getElementById("tabSignUp");
    const signInForm = document.getElementById("signInForm");
    const signUpForm = document.getElementById("signUpForm");
    tabSignIn.onclick = function() {
      tabSignIn.classList.add("active");
      tabSignUp.classList.remove("active");
      signInForm.style.display = "";
      signUpForm.style.display = "none";
    };
    tabSignUp.onclick = function() {
      tabSignUp.classList.add("active");
      tabSignIn.classList.remove("active");
      signInForm.style.display = "none";
      signUpForm.style.display = "";
    };

    // Gestion du formulaire de connexion
    document.querySelector('#signInForm form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('token', data.token);
          alert('Connexion réussie !');
          document.getElementById('popupLogin').style.display = 'none';
          location.reload();
        } else {
          alert('Erreur : ' + data.error);
        }
      } catch (err) {
        alert('Erreur de connexion');
      }
    });

    // Gestion du formulaire d'inscription
    document.querySelector('#signUpForm form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('newemail').value;
      const password = document.getElementById('newpassword').value;
      const prenom = document.getElementById('firstname').value;
      const nom = document.getElementById('lastname').value;

      try {
        const response = await fetch(`${API_URL}/api/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, nom, prenom })
        });

        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('token', data.token);
          alert('Compte créé et connecté !');
          document.getElementById('popupLogin').style.display = 'none';
          location.reload();
        } else {
          alert('Erreur : ' + data.error);
        }
      } catch (err) {
        alert('Erreur lors de l\'inscription');
      }
    });
  </script>
</body>
</html>